# -*- coding: utf-8 -*-
"""
/***************************************************************************
 QRAVEDockWidget
                                 A QGIS plugin
 QRAVE Dock Widget
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                             -------------------
        begin                : 2021-04-12
        git sha              : $Format:%H$
        copyright            : (C) 2021 by NAR
        email                : info@northarrowresearch.com
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""
from __future__ import annotations
from typing import List, Dict
import os


from qgis.PyQt import uic
from qgis.core import Qgis
from qgis.PyQt.QtGui import QStandardItemModel, QStandardItem, QIcon, QDesktopServices
from qgis.PyQt.QtWidgets import QDockWidget, QWidget, QTreeView, QVBoxLayout, QMenu, QAction
from qgis.PyQt.QtCore import pyqtSignal, pyqtSlot, Qt, QModelIndex, QUrl

from .classes.settings import Settings, CONSTANTS
from .classes.basemaps import BaseMaps
from .classes.project import Project, QRaveMapLayer
from .classes.context_menu import ContextMenu
from .meta_widget import MetaType

FORM_CLASS, _ = uic.loadUiType(os.path.join(
    os.path.dirname(__file__), 'ui', 'dock_widget.ui'))


ADD_TO_MAP_TYPES = ['polygon', 'raster', 'point', 'line']


class QRAVEDockWidget(QDockWidget, FORM_CLASS):

    closingPlugin = pyqtSignal()
    dataChange = pyqtSignal()
    showMeta = pyqtSignal()
    metaChange = pyqtSignal(str, str, dict, bool)

    def __init__(self, parent=None):
        """Constructor."""
        super(QRAVEDockWidget, self).__init__(parent)
        # Set up the user interface from Designer.
        # After setupUI you can access any designer object by doing
        # self.<objectname>, and you can use autoconnect slots - see
        # http://doc.qt.io/qt-5/designer-using-a-ui-file.html
        # #widgets-and-dialogs-with-auto-connect

        # self.treeView
        self.setupUi(self)
        self.menu = ContextMenu()

        self.treeView.setContextMenuPolicy(Qt.CustomContextMenu)
        self.treeView.customContextMenuRequested.connect(self.open_menu)
        self.treeView.doubleClicked.connect(self.default_tree_action)
        self.treeView.clicked.connect(self.item_change)

        self.settings = Settings()
        self.model = QStandardItemModel()
        # self.treeView.setStyleSheet(STYLE)

        # Initialize our classes
        self.basemaps = BaseMaps()
        self.treeView.setModel(self.model)
        self.project = Project(self.settings.getValue('projectPath'))

        self.dataChange.connect(self.load)
        self.load()

    @pyqtSlot()
    def load(self):
        # re-initialize our model
        self.model.clear()

        # self.model.setHorizontalHeaderLabels(['Name', 'Height', 'Weight'])
        # self.tree.header().setDefaultSectionSize(180)

        self.project = Project(self.settings.getValue('projectPath'))
        # Load the tree objects
        self.project.load()
        self.basemaps.load()

        # self._populateTree(self.tree, self.model.invisibleRootItem())
        if self.project.exists is True and self.project.qproject is not None:
            self.model.appendRow(self.project.qproject)

        # Now load the basemaps
        region = self.settings.getValue('basemapRegion')
        if self.settings.getValue('basemapsInclude') is True \
                and region is not None and len(region) > 0 \
                and region in self.basemaps.regions.keys():
            self.model.appendRow(self.basemaps.regions[region])

        # Finally expand all levels
        self.treeView.expandAll()

    def closeEvent(self, event):
        self.closingPlugin.emit()
        event.accept()

    def default_tree_action(self, index):
        item = self.model.itemFromIndex(index)
        data = item.data(Qt.UserRole)

        # This is the layer context menu
        if isinstance(data, QRaveMapLayer):
            print("Default Layer Action")

        if data is not None and 'type' in data:

            if data['type'] in ['ROOT']:
                print("Default Project Action")

            elif data['type'] in ['FOLDER', 'BASEMAP_FOLDER', 'BASEMAP_ROOT']:
                print("Default Folder Action")

            elif data['type'] == 'BASEMAP':
                print("Default Basemap Action")

            elif data['type'] == 'VIEW':
                print("Default View Action")

    def item_change(self, postion):
        indexes = self.treeView.selectedIndexes()
        if len(indexes) < 1 or self.project is None or self.project.exists is False:
            return

        # No multiselect so there is only ever one item
        item = self.model.itemFromIndex(indexes[0])
        data = item.data(Qt.UserRole)
        self.change_meta(item, data)

    def change_meta(self, item: QStandardItem, data, show=False):
        if isinstance(data, QRaveMapLayer):
            self.metaChange.emit(item.text(), MetaType.LAYER, data.meta, show)
        elif data is not None and 'type' in data:
            if data['type'] in ['ROOT']:
                self.metaChange.emit(item.text(), MetaType.PROJECT, {
                    'project': self.project.meta,
                    'warehouse': self.project.warehouse_meta
                }, show)
            elif data['type'] in ['FOLDER', 'BASEMAP_FOLDER', 'BASEMAP_ROOT']:
                self.metaChange.emit(item.text(), MetaType.FOLDER, data, show)
        else:
            self.metaChange.emit(item.text(), MetaType.NONE, data, show)

    def open_menu(self, position):

        indexes = self.treeView.selectedIndexes()
        if len(indexes) < 1:
            return

        # No multiselect so there is only ever one item
        idx = indexes[0]
        item = self.model.itemFromIndex(indexes[0])
        data = item.data(Qt.UserRole)

        # This is the layer context menu
        if isinstance(data, QRaveMapLayer):
            self.layer_context_menu(idx, item, data)

        elif data is not None and 'type' in data:
            if data['type'] in ['ROOT']:
                self.project_context_menu(idx, item, data)

            elif data['type'] in ['FOLDER', 'BASEMAP_FOLDER', 'BASEMAP_ROOT']:
                self.folder_context_menu(idx, item, data)

            elif data['type'] == 'VIEW':
                self.view_context_menu(idx, item, data)

        self.menu.exec_(self.treeView.viewport().mapToGlobal(position))

    def layer_context_menu(self, idx: QModelIndex, item: QStandardItem, data: QRaveMapLayer):
        self.menu.clear()
        self.menu.addAction('ADD_TO_MAP', enabled=data.exists)
        self.menu.addAction('VIEW_LAYER_META', lambda: self.change_meta(item, data, True))
        self.menu.addAction('VIEW_WEB_SOURCE')
        self.menu.addAction('BROWSE_FOLDER', lambda: self.file_system_locate(data.lyr_path))

    def folder_context_menu(self, idx: QModelIndex, item: QStandardItem, data):
        self.menu.clear()
        self.menu.addAction('ADD_ALL_TO_MAP')
        self.menu.addSeparator()
        self.menu.addAction('COLLAPSE_ALL', lambda: self.toggleSubtree(item, False))
        self.menu.addAction('EXPAND_ALL', lambda: self.toggleSubtree(item, True))

    def view_context_menu(self, idx: QModelIndex, item: QStandardItem, data):
        self.menu.clear()
        self.menu.addAction('ADD_ALL_TO_MAP')

    def project_context_menu(self, idx: QModelIndex, item: QStandardItem, data):
        self.menu.clear()
        self.menu.addAction('COLLAPSE_ALL', lambda: self.toggleSubtree(None, False))
        self.menu.addAction('EXPAND_ALL', lambda: self.toggleSubtree(None, True))

        self.menu.addSeparator()
        self.menu.addAction('BROWSE_PROJECT_FOLDER', lambda: self.file_system_locate(self.project.project_xml_path))
        self.menu.addAction('VIEW_PROJECT_META', lambda: self.change_meta(item, data, True))
        self.menu.addAction('ADD_ALL_TO_MAP')
        self.menu.addSeparator()
        self.menu.addAction('REFRESH_PROJECT_HIERARCHY')
        self.menu.addAction('CUSTOMIZE_PROJECT_HIERARCHY')

    def basemap_context_menu(self, idx: QModelIndex, item: QStandardItem, data):
        self.menu.clear()
        self.menu.addAction('ADD_TO_MAP')

    def file_system_open(self, fpath: str):
        qurl = QUrl.fromLocalFile(fpath)
        QDesktopServices.openUrl(qurl)

    def file_system_locate(self, fpath: str):

        final_path = os.path.dirname(fpath)
        while not os.path.isdir(final_path):
            final_path = os.path.dirname(final_path)

        qurl = QUrl.fromLocalFile(final_path)
        QDesktopServices.openUrl(qurl)

    def toggleSubtree(self, item: QStandardItem = None, expand=True):

        def _recurse(curritem):
            idx = self.model.indexFromItem(item)
            if expand is not self.treeView.isExpanded(idx):
                self.treeView.setExpanded(idx, expand)

            for row in range(curritem.rowCount()):
                _recurse(curritem.child(row))

        if item is None:
            if expand is True:
                self.treeView.expandAll()
            else:
                self.treeView.collapseAll()
        else:
            _recurse(item)
